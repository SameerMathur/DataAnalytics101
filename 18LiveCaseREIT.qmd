# Case (2): Real-Estate Sector in the S&P500

**Chapter 18, *Last updated: Jan 07, 2024***

## Real Estate Sector in the S&P 500

<insert review here>

### Set up the data

Load Packages:

```{r, warning=FALSE}
# Load the required libraries, suppressing annoying startup messages
library(dplyr, quietly = TRUE, warn.conflicts = FALSE) # For data manipulation
library(tibble, quietly = TRUE, warn.conflicts = FALSE) # For data manipulation
library(ggplot2, quietly = TRUE, warn.conflicts = FALSE) # For data visualization
library(ggpubr, quietly = TRUE, warn.conflicts = FALSE) # For data visualization

library(gsheet, quietly = TRUE, warn.conflicts = FALSE) # For Google Sheets
library(rmarkdown, quietly = TRUE, warn.conflicts = FALSE) # For writing
library(knitr, quietly = TRUE, warn.conflicts = FALSE) # For tables
library(kableExtra, quietly = TRUE, warn.conflicts = FALSE) # For tables
library(scales)  # For formatting currency
```

Read the data from a Google Sheet into a tibble:

```{r, warning=FALSE}
# Read S&P500 stock data present in a Google Sheet.
library(gsheet)
prefix <- "https://docs.google.com/spreadsheets/d/"
sheetID <- "14mUlNNpeuV2RouT9MKaAWKUpvjRijzQu40DdWJgyKPQ"
url500 <- paste(prefix,sheetID) # Form the URL to connect to
sp500Data <- gsheet2tbl(url500) # Read it into a tibble called sp500Data
```

Read GICS classificaiton of S&P 500 stocks:

```{r}
# Read GICS classificaiton of S&P 500 stocks from a Google Sheet.
library(gsheet)
prefix2 <- "https://docs.google.com/spreadsheets/d/"
sheetID2 <- "1WrVA8dPYvQsc_mXVctgTntRLS02qd7ubzcdAsw03Lgk"
urlgics <- paste(prefix2, sheetID2) # Form the URL to connect to
gics <- gsheet2tbl(urlgics) # Read it into a tibble called gics
```

Join the data:

```{r}
# Merging dataframes
sp500 <- merge(sp500Data, 
               gics , 
               id = "Stock")
```

Rename the data columns:

```{r, warning=FALSE}
# Define a mapping of new column names
new_names <- c(
  "Stock", "Date", "StockName", "Sector", "Industry", 
  "MarketCap", "Price", "Low52Wk", "High52Wk", 
  "ROE", "ROA", "ROIC", "GrossMargin", 
  "OperatingMargin", "NetMargin", "PE", 
  "PB", "EVEBITDA", "EBITDA", "EPS", 
  "EBITDA_YOY", "EBITDA_QYOY", "EPS_YOY", 
  "EPS_QYOY", "PFCF", "FCF", 
  "FCF_QYOY", "DebtToEquity", "CurrentRatio", 
  "QuickRatio", "DividendYield", 
  "DividendsPerShare_YOY", "PS", 
  "Revenue_YOY", "Revenue_QYOY", "Rating",
  "Security", "GICSSector", "GICSSubIndustry"
)
# Rename the columns using the new_names vector
colnames(sp500)<-new_names
```

Create new columns.

```{r}
library(dplyr)
sp500 <- sp500 %>%
  mutate(Low52WkPerc = round((Price - Low52Wk) * 100 / Low52Wk, 2),
         High52WkPerc = round((High52Wk - Price) * 100 / High52Wk, 2),
         MarketCapBillions = round(MarketCap / 1e9, 3) # Convert MarketCap to billions
         )
```


Review the column names:

```{r, warning=FALSE}
colnames(sp500)
```


Format the Prices.

```{r}
library(dplyr)
library(scales)  # For formatting currency

sp500 <- sp500 %>%
  mutate(
    Price = scales::dollar(round(Price, 2)),  # format the Price as a dollar amount
    High52Wk = scales::dollar(round(High52Wk, 2)),  # format the 52 Week High 
    Low52Wk = scales::dollar(round(Low52Wk, 2))  # format the 52 Week Low 
  )
```

Model the Rating as a `factor()` variable.

```{r, warning=FALSE, eval=TRUE, echo=TRUE}
sp500$Rating <- as.factor(sp500$Rating)
str(sp500$Rating)
levels(sp500$Rating)
table(sp500$Rating)
```

Model `GICSSector` as a `factor`.

```{r, warning=FALSE, eval=TRUE, echo=TRUE}
sp500$GICSSector <- as.factor(sp500$GICSSector)
str(sp500$GICSSector)
levels(sp500$GICSSector)

```

### Role Play?

A prestigious investment fund is ready to channel \$1 Million into the US Real Estate sector in the S&P500. For example, Real Estate Investment Trusts, commonly known as REITs, offer a distinctive way to engage with real estate markets without the cumbersome process of directly owning property. Suppose our mission is to allocate `$1 Million` to the "best" REIT(s). Pinpoint the top 1, 2 or 3 REITs that present the most promising short-term trading opportunities.

### The **Real Estate** Sector within the S&P500

We focus on investment opportunities **within the Real Estate sector** of the S&P500. We want to determine the *fundamentally strongest* AND *most reasonably priced* shares for *short-to-medium term* investing. We create a tibble named realestate, filtering the shares that belong to the Real Estate sector.

```{r}
realestate = sp500 %>% 
  filter(GICSSector == "Real Estate") 
```

We list the stocks in the real estate sector.

```{r}
library(dplyr)
library(kableExtra)

# Select stocks with their Market Cap in billions
real_estate_stocks <- realestate %>%
  arrange(desc(MarketCapBillions)) %>%
  select(Stock, StockName, MarketCapBillions, Price)

# Displaying the data
real_estate_stocks %>%
  kable("html", caption = "Real Estate Sector Stocks, with Market Cap in Billions") %>%
  kable_styling()
```

### Significance of 52-Week Low, High Price

The 52-week low price of a stock is a significant indicator for multiple reasons, especially when considering shares listed on major indices like the S&P 500. Here's why this metric is noteworthy:

1.  **Historical Perspective**: The 52-week low offers a snapshot of how low the stock has traded over the past year relative to its current price, providing context about its price journey.

2.  **Potential Entry Point**: Some investors view stocks that are near their 52-week low as potential buying opportunities, under the assumption that the stock might be undervalued and could rebound.

3.  **Psychological Level**: Stocks approaching their 52-week low can be seen as testing a significant support level. If a stock consistently fails to breach its 52-week low, it might indicate that the market values the stock at that level, and it's resistant to falling below it.

4.  **Basis for Technical Analysis**: For technical analysts or traders, the 52-week low serves as a critical reference point. A consistent breach of this level might signify a bearish trend, while a rebound can indicate potential recovery.

5.  **Yield Implications for Dividend Stocks**: For dividend-paying stocks, a price near the 52-week low (assuming the dividend hasn't been cut) would imply a higher dividend yield, potentially making it attractive for income-seeking investors.

-   **Note of Caution:** While the 52-week low is a valuable reference point, it's essential to interpret it in conjunction with other financial and market indicators. A stock trading near its 52-week low doesn't automatically make it a good buy, just as a stock trading near its 52-week high doesn't automatically make it overvalued. Comprehensive analysis, should inform investment decisions.

We want to analyze stock prices relative to their 52 Week Low and 52 Week High respectively, to understand their relative price attractiveness.

Here, a new column named `Low52WkPerc` is being added. The column contains the percentage change between the current price (`Price`) and its 52-week low (`Low52Wk`). The formula used is: $$Low52WkPerc = \frac{(CurrentPrice - 52WeekLow)*100}{52WeekLow}$$

Another column named `High52WkPerc` represents the percentage change between the 52-week high (`High52Wk`) and the current price (`Price`). We round off the data to two decimal places for clarity.
\newpage

Consider the summary statistics of the Market Capitalization of the real estate stocks within the S&P500

```{r echo=TRUE}
realestate %>% summarise(
  N = n(),
  Mean = mean(MarketCapBillions),
  SD = sd(MarketCapBillions),
  Median = median(MarketCapBillions),
  Q1 = quantile(MarketCapBillions, 0.25),
  Q3 = quantile(MarketCapBillions, 0.75),
  Min = min(MarketCapBillions),
  Max = max(MarketCapBillions),
  Sum = sum(MarketCapBillions)
) %>% 
  round(2) %>%
  kable("html", caption = "Summary Statistics of Market Capitalizaiton of realestate (Billion USD)") %>% 
  kable_styling()
```

-   As can be seen, the S&P500 consists of `r nrow(realestate)` real estate stocks.

We want to determine the *fundamentally strongest* AND *most reasonably priced* shares for *short-to-medium term* investing.

### Select Specific Coulumns from the filtered dataframe 

```{r warning=FALSE, eval=TRUE, echo=TRUE}
ts3 <- realestate %>%
		select(Date, Stock, StockName, MarketCapBillions, Price, Low52Wk, High52Wk, Low52WkPerc, High52WkPerc,
		       ROE, ROA,ROIC,GrossMargin, GrossMargin, 
		       NetMargin, Rating) %>% 
    arrange(desc(ROE))

colnames(ts3)
```

## Summary Statistics of Low52WkPerc (Price rel. to 52-Week Low)

```{r eval=TRUE, echo=TRUE, warning=FALSE}
summaryStats <- ts3 %>% summarise(
  N = n(),
  Mean = mean(Low52WkPerc),
  SD = sd(Low52WkPerc),
  Median = median(Low52WkPerc),
  Q1 = quantile(Low52WkPerc, 0.25),
  Q3 = quantile(Low52WkPerc, 0.75),
  Min = min(Low52WkPerc),
  Max = max(Low52WkPerc)
) 

Low52WkPercQ1 <- summaryStats$Q1 # Save Q1 of Low52WkPerc

summaryStats %>% 
  round(2) %>%
  kable("html", caption = "Summary Statistics of Low52WkPerc (Price rel. to 52-Week Low)") %>% 
  kable_styling()
```

*Low52WkPerc for all the realestate Stocks, as shown below*

```{r eval=TRUE, echo=FALSE, warning=FALSE}
PlotBox <- ggboxplot(ts3, 
            y = "Low52WkPerc", 
            rug = TRUE, 
            color = "black",
            fill = "gold",
            add = "jitter",
            orientation = "horizontal",
            title = "Box Plot showing (Median, Q1, Q3) of Low52WkPerc"
)
```

```{r  eval=TRUE, echo=FALSE, warning=FALSE}
# Create a summary data frame
data_summary <- ts3 %>%
  summarise(
    MeanLow52WkPerc = mean(Low52WkPerc, na.rm = TRUE),
    SDLow52WkPerc = sd(Low52WkPerc, na.rm = TRUE)
  )

PlotBar <- ggplot(data_summary, 
       aes(y = "", 
           x = MeanLow52WkPerc)) +
  geom_bar(stat = "identity", 
           fill = "lightpink", color = "lightpink") +
  geom_errorbar(aes(xmin = MeanLow52WkPerc - SDLow52WkPerc, 
                    xmax = MeanLow52WkPerc + SDLow52WkPerc), 
                width = .2) +
  labs(x = "Low52WkPerc", y = "",
       title = "Bar Plot showing (Mean +/- SD) of Low52WkPerc") +
  theme_minimal() 
```

```{r eval=TRUE, echo=FALSE, warning=FALSE}
# Combine the plots using ggarrange()
ggarrange(PlotBox, PlotBar, nrow = 2)
```

## Inexpensive Stocks with Low52WkPerc \< Q1(Low52WkPerc)

```{r eval=TRUE, echo=TRUE, warning=FALSE}
ts3 %>% 
  select(Stock, StockName, Price, Low52Wk, Low52WkPerc) %>% 
  filter(Low52WkPerc < Low52WkPercQ1) %>% 
  arrange(Low52WkPerc)%>%
  kable("html", caption = "Inexpensive Stocks with Low52WkPerc < Q1(Low52WkPerc)") %>% 
  kable_styling()
```

### Summary Statistics of Return on Equity (ROE)

```{r}
summaryStats <- ts3 %>% summarise(
  N = n(),
  Mean = mean(ROE, na.rm = TRUE),
  SD = sd(ROE, na.rm = TRUE),
  Median = median(ROE, na.rm = TRUE),
  Q1 = quantile(ROE, 0.25, na.rm = TRUE),
  Q3 = quantile(ROE, 0.75, na.rm = TRUE),
  Min = min(ROE, na.rm = TRUE),
  Max = max(ROE, na.rm = TRUE)
) 

ROE_Q3 <- summaryStats$Q3

summaryStats %>% 
  round(2) %>%
  kable("html", caption = "Summary Statistics of Return on Equity (ROE)") %>% 
  kable_styling()
```

-   ROE for all the Stocks in realestate, as shown below

```{r eval=TRUE, echo=FALSE, warning=FALSE}
PlotBox <- ggboxplot(ts3, 
            y = "ROE", 
            rug = TRUE, 
            color = "black",
            fill = "gold",
            add = "jitter",
            orientation = "horizontal",
            title = "Box Plot showing (Median, Q1, Q3) of ROE"
)
```

```{r eval=TRUE, echo=FALSE, warning=FALSE}
# Create a summary data frame
data_summary <- ts3 %>%
  summarise(
    MeanROE = mean(ROE, na.rm = TRUE),
    SDROE = sd(ROE, na.rm = TRUE)
  )
# Generate a Bar Plot
PlotBar <- ggplot(data_summary, 
       aes(y = "", 
           x = MeanROE)) +
  geom_bar(stat = "identity", 
           fill = "lightpink", color = "lightpink") +
  geom_errorbar(aes(xmin = MeanROE - SDROE, 
                    xmax = MeanROE + SDROE), 
                width = .2) +
  labs(x = "ROE", y = "",
       title = "Bar Plot showing (Mean +/- SD) of ROE") +
  theme_minimal() 
```

```{r eval=TRUE, echo=FALSE, warning=FALSE}
# Combine the plots using ggarrange()
ggarrange(PlotBox, PlotBar, nrow = 2)
```

### Stocks with ROE \> Q3(ROE)

```{r}
ts3 %>% 
  select(Stock, StockName, Price, ROA, ROE, Low52Wk, Low52WkPerc) %>% 
  filter(ROE > ROE_Q3) %>%
  arrange(desc(ROE)) %>%
  kable("html", caption = "Stocks with ROE > Q3(ROE)") %>% 
  kable_styling()

```

### Summary Statistics of Return on Equity (ROA)

```{r}
summaryStats <- ts3 %>% summarise(
  N = n(),
  Mean = mean(ROA, na.rm = TRUE),
  SD = sd(ROA, na.rm = TRUE),
  Median = median(ROA, na.rm = TRUE),
  Q1 = quantile(ROA, 0.25, na.rm = TRUE),
  Q3 = quantile(ROA, 0.75, na.rm = TRUE),
  Min = min(ROA, na.rm = TRUE),
  Max = max(ROA, na.rm = TRUE)
) 

ROA_Q3 <- summaryStats$Q3

summaryStats %>% 
  round(2) %>%
  kable("html", caption = "Summary Statistics of Return on Equity (ROA)") %>% 
  kable_styling()
```

-   ROA for all the Stocks in realestate, as shown below

```{r eval=TRUE, echo=FALSE, warning=FALSE}
PlotBox <- ggboxplot(ts3, 
            y = "ROA", 
            rug = TRUE, 
            color = "black",
            fill = "gold",
            add = "jitter",
            orientation = "horizontal",
            title = "Box Plot showing (Median, Q1, Q3) of ROA"
)
```

```{r eval=TRUE, echo=FALSE, warning=FALSE}
# Create a summary data frame
data_summary <- ts3 %>%
  summarise(
    MeanROA = mean(ROA, na.rm = TRUE),
    SDROA = sd(ROA, na.rm = TRUE)
  )
# Generate a Bar Plot
PlotBar <- ggplot(data_summary, 
       aes(y = "", 
           x = MeanROA)) +
  geom_bar(stat = "identity", 
           fill = "lightpink", color = "lightpink") +
  geom_errorbar(aes(xmin = MeanROA - SDROA, 
                    xmax = MeanROA + SDROA), 
                width = .2) +
  labs(x = "ROA", y = "",
       title = "Bar Plot showing (Mean +/- SD) of ROA") +
  theme_minimal() 
```

```{r eval=TRUE, echo=FALSE, warning=FALSE}
# Combine the plots using ggarrange()
ggarrange(PlotBox, PlotBar, nrow = 2)
```

### Stocks with ROA \> Q3(ROA)

```{r}
ts3 %>% 
  select(Stock, StockName, Price, ROA, ROE, Low52Wk, Low52WkPerc) %>% 
  filter(ROA > ROA_Q3) %>%
  arrange(desc(ROA)) %>%
  kable("html", caption = "Stocks with ROA > Q3(ROA)") %>% 
  kable_styling()

```

### ROE versus ROA and colored by Price rel. to 52 Week Low

```{r, warning=FALSE}
top10 <- 
  ts3 %>% 
  select(Stock, Price, Low52Wk, Low52WkPerc, ROA, ROE) %>% 
  arrange(desc(ROE))%>%
  slice(1:10)

top10$name <- top10$Stock

ggscatter(top10, 
          x = "ROA", 
          y = "ROE", 
          size = "Low52WkPerc",
          color = "Low52WkPerc",
          alpha = 0.5,
          label = "name", 
          repel = TRUE,
          title = "ROE vs ROA, Low52WkPerc for real estate with highest ROE") + 
  gradient_color(c("darkgreen",  "red"))
```

### Summary Statistics of All key variables in real estate

```{r}
ts3 <- na.omit(ts3)

ROESum <- ts3 %>%
  summarise(
    Mean = mean(ROE),
    Stdev = sd(ROE),
    Median= median(ROE),
    Q1 = quantile(ROE, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(ROE, probs = 0.75, na.rm = TRUE),
    Min = min(ROE),
    Max = max(ROE)
  )

ROESum <- round(ROESum,2)


ROASum <- ts3 %>%
  summarise(
    Mean = mean(ROA),
    Stdev = sd(ROA),
    Median= median(ROA),
    Q1 = quantile(ROA, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(ROA, probs = 0.75, na.rm = TRUE),
    Min = min(ROA),
    Max = max(ROA)
  )

ROASum <- round(ROASum,2)

ROICSum <- ts3 %>%
  summarise(
    Mean = mean(ROIC),
    Stdev = sd(ROIC),
    Median= median(ROIC),
    Q1 = quantile(ROIC, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(ROIC, probs = 0.75, na.rm = TRUE),
    Min = min(ROIC),
    Max = max(ROIC)
  )

ROICSum <- round(ROICSum,2)

GrossMarginSum <- ts3 %>%
  summarise(
    Mean = mean(GrossMargin),
    Stdev = sd(GrossMargin),
    Median= median(GrossMargin),
    Q1 = quantile(GrossMargin, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(GrossMargin, probs = 0.75, na.rm = TRUE),
    Min = min(GrossMargin),
    Max = max(GrossMargin)
  )

GrossMarginSum <- round(GrossMarginSum,2)

NetMarginSum <- ts3 %>%
  summarise(
    Mean = mean(NetMargin),
    Stdev = sd(NetMargin),
    Median= median(NetMargin),
    Q1 = quantile(NetMargin, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(NetMargin, probs = 0.75, na.rm = TRUE),
    Min = min(NetMargin),
    Max = max(NetMargin)
  )

NetMarginSum <- round(NetMarginSum,2)

Metrics <- c("ROE","ROA","ROIC","GrossMargin","NetMargin")

ftab <- rbind(ROESum, ROASum, ROICSum, GrossMarginSum, NetMarginSum)
ftab <- cbind(Metrics, ftab)
ftab
```
